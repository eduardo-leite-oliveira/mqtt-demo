<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat MQTT</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; background: #f5f5f5; }
    h1 { color: #2c3e50; }
    input, button { margin: 5px 0; padding: 10px; font-size: 1em; width: 100%; }
    #mensagens { margin-top: 20px; background: #fff; padding: 10px; border: 1px solid #ccc; height: 300px; overflow-y: auto; }
    .msg { border-bottom: 1px solid #eee; padding: 5px 0; }
    .topico { font-weight: bold; }
    .hora { color: #999; font-size: 0.9em; }
  </style>
</head>
<body>

<h1>Chat MQTT</h1>

<label>Client ID:</label>
<input type="text" id="clientId" placeholder="Seu nome ou identificador" />

<label>T√≥pico:</label>
<input type="text" id="topico" placeholder="ex: apresentacao/mqtt" />

<label>Mensagem:</label>
<input type="text" id="mensagem" placeholder="Digite sua mensagem" />

<button onclick="conectar()">Conectar</button>
<button onclick="enviarMensagem()">Enviar</button>

<div id="mensagens"></div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
  let client = null;

  function conectar() {
    const clientId = document.getElementById("clientId").value || "cliente_" + Math.random().toString(16).substr(2, 8);
    const topico = document.getElementById("topico").value;

    if (!topico) {
      alert("Digite um t√≥pico antes de conectar.");
      return;
    }

    const options = {
      clientId: clientId,
      clean: true,
      connectTimeout: 4000,
      reconnectPeriod: 4000
    };

    // ATEN√á√ÉO: Usar WebSocket para navegador
    client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt", options);

    client.on("connect", () => {
      logMensagem("‚úÖ Conectado como <strong>" + clientId + "</strong>");
      client.subscribe(topico, (err) => {
        if (!err) logMensagem("üì° Subscrito ao t√≥pico <strong>" + topico + "</strong>");
      });
    });

    client.on('message', (topic, message) => {
      const hora = new Date().toLocaleTimeString();
      let payload = message.toString();
      let remetente = "Desconhecido";

      // tenta extrair clientId se for JSON
      try {
        const obj = JSON.parse(payload);
        if (obj.clientId) {
          remetente = obj.clientId;
        }
        // se quiser s√≥ mostrar uma mensagem espec√≠fica do JSON, pode ajustar payload aqui
      } catch (e) {
        // n√£o √© JSON, deixar payload igual
      }

      log(`[${hora}] [${topic}]\n${remetente}: ${payload}\n`);
    });


    client.on("error", err => {
      logMensagem("‚ùå Erro: " + err.message);
    });
  }

  function enviarMensagem() {
    const topico = document.getElementById("topico").value;
    const mensagem = document.getElementById("mensagem").value;
    const remetente = document.getElementById("clientId").value;

    if (!client || !client.connected) {
      alert("Voc√™ precisa se conectar primeiro.");
      return;
    }

    if (!mensagem || !topico) return;

    const payload = `[${remetente}]: ${mensagem}`;
    client.publish(topico, payload);
    document.getElementById("mensagem").value = "";
  }

  function logMensagem(html) {
    const div = document.createElement("div");
    div.classList.add("msg");
    div.innerHTML = html;
    document.getElementById("mensagens").appendChild(div);
    document.getElementById("mensagens").scrollTop = document.getElementById("mensagens").scrollHeight;
  }
</script>

</body>
</html>
